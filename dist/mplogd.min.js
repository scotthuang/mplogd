!function(t){"function"==typeof define&&define.amd?define(t):t()}(function(){"use strict";var t,e;t=void 0,e=function(){var r="initing",i="inited",a="failed",l=1,s=2,d=3,o="info",n="warn",u="error";function c(t){return(t=t.toString())[1]?t:"0"+t}function h(t){var e="";return/^[0-9]{4}-[0-9]{2}-[0-9]{2}/.test(t)?e+=new Date(t).getTime():/^\d{13}$/.test(t)&&(e+=t),parseInt(e)}var p="mplog",f="logs",g="readwrite",m="readonly",e=(t.prototype.init=function(){try{this.createDB()}catch(t){console.log("Mplog createDB failed")}},t.prototype.createDB=function(){var n=this;if(this.indexedDB)if(this.dbStatus===r){var t=indexedDB.open(this.DB_NAME,this.DB_VERSION);t.onerror=function(t){n.checkDB(t);var e=s;if(t.target.error&&"VersionError"===t.target.error.name){try{var r=t.target.error.message;if(-1<r.search(/The requested version \([0-9]+\) is less than the existing version \([0-9]\)/)){var o=r.match(/[0-9]+/gi)[1];o>n.DB_VERSION&&(n.DB_VERSION=o)}}catch(t){console.log(t)}e=d,n.dbStatus=a}n.throwError(e,"indexedDB open error, message:",t.target.error)},t.onsuccess=function(t){if(n.dbStatus===r){n.db=t.target.result,n.dbStatus=i,n.db.onerror=function(t){return n.throwError(s,"indexedDB error",t.target.error)},n.db.onversionchange=function(t){n.db.close(),n.dbStatus=a,n.currentRetryCount=n.maxRetryCount+1,n.throwError(d,"indexedDB version change, message:",t.target.error)};try{n.poolHandler.consume()}catch(t){n.throwError(d,"consume pool error",t)}n.DB_NAME===p&&n.DB_STORE_NAME===f&&setTimeout(function(){n.dbStatus!==i?n.poolHandler.push(function(){return n.keep(7)}):n.keep(7)},1e3)}},t.onblocked=function(){n.throwError(s,"indexedDB is blocked")},t.onupgradeneeded=function(t){n.db=t.target.result;try{if(n.DB_NAME===p&&n.DB_STORE_NAME===f)if(n.db.objectStoreNames.contains(n.DB_STORE_NAME)){if(t.oldVersion<3){var e=t.target.transaction.objectStore(n.DB_STORE_NAME);e.createIndex("timestamp","timestamp",{unique:!1}),e.openCursor().onsuccess=function(t){var e=t.target.result;e&&(e.update({time:e.value.time,level:e.value.level,location:e.value.location,description:e.value.description,data:e.value.data,timestamp:new Date(e.value.time).getTime()}),e.continue())}}}else{var r=n.db.createObjectStore(n.DB_STORE_NAME,{autoIncrement:!0});r.createIndex("location","location",{unique:!1}),r.createIndex("level","level",{unique:!1}),r.createIndex("description","description",{unique:!1}),r.createIndex("data","data",{unique:!1}),r.createIndex("timestamp","timestamp",{unique:!1})}"function"==typeof n.onupgradeneeded&&n.onupgradeneeded(t)}catch(t){n.dbStatus=a,n.throwError(d,"indexedDB upgrade error",t)}}}else this.throwError(s,"indexedDB init error");else this.throwError(s,"your browser not support IndexedDB.")},t.prototype.checkDB=function(t){t&&t.target&&t.target.error&&"QuotaExceededError"===t.target.error.name&&this.clean()},t.prototype.getTransaction=function(t){var e=this,r=null;if(this.dbStatus===a)r=null;else{try{r=this.db.transaction(this.DB_STORE_NAME,t)}catch(t){r=null}r&&(r.onerror=function(t){return t.stopPropagation(),e.throwError(d,"transaction is error")},r.onabort=function(t){t.stopPropagation(),t.target.error&&"QuotaExceededError"===t.target.error.name&&e.clean()})}return r},t.prototype.insertItems=function(t){var e,r=this,o=this.getTransaction(g);if(null===o)return this.throwError(d,"transaction is null"),!1;for(var n=o.objectStore(this.DB_STORE_NAME),i=0,a=t;i<a.length;i++){var s=a[i];(e=n.put(s)).onsuccess=function(){},e.onerror=function(t){return r.throwError(l,"add log failed",t.target.error)}}},t.prototype.get=function(t,e,r){if(this.DB_NAME!==p||this.DB_STORE_NAME!==f)return!1;var o=this.getTransaction(m);if(null===o)return this.throwError(d,"transaction is null"),!1;var n=(new Date).getTime(),i=(new Date).getTime();try{n=h(t),i=h(e)}catch(t){this.throwError(l,"invalid time")}var a=o.objectStore(this.DB_STORE_NAME),s=[],u=IDBKeyRange.bound(n,i);return a.index("timestamp").openCursor(u).onsuccess=function(t){var e=t.target.result;e?(s.push({time:e.value.time,level:e.value.level,location:e.value.location,description:e.value.description,data:e.value.data,timestamp:e.value.timestamp}),e.continue()):r(s)},!0},t.prototype.clean=function(){var e=this;this.db&&this.db.close();var t=this.indexedDB.deleteDatabase(this.DB_NAME);t.onerror=function(t){e.throwError(s,"clean database failed",t.target.error)},t.onsuccess=function(){e.dbStatus=a}},t.prototype.keep=function(t){var e=this;if(this.DB_NAME===p&&this.DB_STORE_NAME===f){var r=this.getTransaction(g);if(null!==r){var o=r.objectStore(this.DB_STORE_NAME);if(t){var n=Date.now()-60*t*60*24*1e3,i=IDBKeyRange.upperBound(n),a=o.index("timestamp").openCursor(i);a.onsuccess=function(t){var e=t.target.result;e&&(e.delete(),e.continue())},a.onerror=function(t){return e.throwError(l,"keep logs error",t.target.error)}}else o.clear().onerror=function(t){return e.throwError(s,"indexedb_keep_clear",t.target.error)}}else this.throwError(d,"transaction is null")}},t.prototype.throwError=function(t,e,r){var o=this;this.currentErrorNum+=t,this.currentErrorNum>=this.maxErrorNum&&(this.dbStatus=a,this.poolHandler.pool=[],this.currentErrorNum=0);var n="";r&&(e=e+":"+(r.message||r.stack||r.name),n=r.toString()),console.error&&console.error("Mplog: error msg: "+e+", error detail: "+n),this.dbStatus===a&&(this.timer=setInterval(function(){o.retryDBConnection()},this.retryInterval))},t.prototype.retryDBConnection=function(){this.currentRetryCount++,this.currentRetryCount>this.maxRetryCount?(this.dbStatus=a,this.poolHandler.pool=[]):(this.dbStatus=r,this.createDB()),clearInterval(this.timer)},t);function t(t,e){this.defaultDbName="mplog",this.defaultDbStoreName="logs",this.dbStatus=r,this.currentErrorNum=0,this.maxRetryCount=3,this.currentRetryCount=0,this.retryInterval=6e3,this.DB_NAME=t&&t.dbName?t.dbName:this.defaultDbName,this.DB_STORE_NAME=t&&t.dbStoreName?t.dbStoreName:f,this.DB_VERSION=t&&void 0!==t.dbVersion?t.dbVersion:1,this.indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,this.onupgradeneeded=t&&t.onupgradeneeded?t.onupgradeneeded:null,this.maxErrorNum=t&&t.maxErrorNum?t.maxErrorNum:3,this.poolHandler=e,this.init()}var v=(E.prototype.push=function(t){this.pool.length<this.poolSize&&this.pool.push(t)},E.prototype.consume=function(){for(var t=this.pool.shift();t;)t(),t=this.pool.shift()},E);function E(){this.poolSize=100,this.pool=[]}var x=(D.prototype.log=function(t,e,r,o){var n=new Date,i={time:function(t){var e=t.getFullYear(),r=t.getMonth()+1,o=t.getDate(),n=t.getHours(),i=t.getMinutes(),a=t.getSeconds();return[e,r,o].map(c).join("-")+" "+[n,i,a].map(c).join(":")}(n),location:t,level:e,description:r,data:this.filterFunction(o),timestamp:n.getTime()};this.bufferLog.push(i),this.bufferLog.length>=this.bufferSize&&this.flush()},D.prototype.filterFunction=function(t){var e={};try{if("function"==typeof t)return t.toString();if("object"!=typeof t)return t;for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&"function"!=typeof t[r]&&(e[r]=this.filterFunction(t[r]));return e}catch(t){return{error:"filterFunction error"}}},D.prototype.flush=function(){var t=this;return 0!==this.bufferLog.length&&(this.mpIndexedDB.dbStatus!==i?this.poolHandler.push(function(){return t.flush()}):(this.mpIndexedDB.insertItems(this.bufferLog),this.bufferLog=[],0))},D.prototype.get=function(t,e,r){var o=this;if(this.mpIndexedDB.dbStatus!==i)return this.poolHandler.push(function(){return o.get(t,e,r)});this.mpIndexedDB.get(t,e,r)},D.prototype.keep=function(t){var e=this;if(this.mpIndexedDB.dbStatus!==i)return this.poolHandler.push(function(){return e.keep(t)});this.mpIndexedDB.keep(t)},D);function D(t){this.defaultAjaxFilter=null,this.bufferLog=[],this.autoLogError=!(!t||void 0===t.autoLogError)&&t.autoLogError,this.autoLogRejection=!(!t||void 0===t.autoLogRejection)&&t.autoLogRejection,this.autoLogAjax=!(!t||void 0===t.autoLogAjax)&&t.autoLogAjax,this.logAjaxFilter=t&&t.logAjaxFilter&&t.logAjaxFilter?t.logAjaxFilter:this.defaultAjaxFilter,this.maxErrorNum=t&&t.maxErrorNum?t.maxErrorNum:3,this.bufferSize=t&&void 0!==t.bufferSize?1*t.bufferSize:3,this.poolHandler=new v,this.mpIndexedDB=new e(t,this.poolHandler)}function b(t){this.defaultAjaxFilter=null,this.xhrOpen=XMLHttpRequest.prototype.open,this.xhrSend=XMLHttpRequest.prototype.send,this.location=t&&t.location?t.location:window.location.href,this.autoLogError=!(!t||void 0===t.autoLogError)&&t.autoLogError,this.autoLogRejection=!(!t||void 0===t.autoLogRejection)&&t.autoLogRejection,this.autoLogAjax=!(!t||void 0===t.autoLogAjax)&&t.autoLogAjax,this.logAjaxFilter=t&&t.logAjaxFilter&&t.logAjaxFilter?t.logAjaxFilter:this.defaultAjaxFilter,this.logController=new x(t),this.bindEvent()}return b.prototype.bindEvent=function(){var e=this;this.autoLogError&&window.addEventListener("error",function(t){e.error("[OnError]: "+t.message,"("+t.lineno+'_("行")'+t.colno+'_("列"))')}),this.autoLogRejection&&window.addEventListener("unhandledrejection",function(t){e.error("[OnRejection]:",t.reason)}),this.ajaxHanler(),this.saveUnstoreData()},b.prototype.ajaxHanler=function(){if(this.autoLogAjax){var o,n,i=this;XMLHttpRequest.prototype.open=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];o=t[0],n=function(t){var e=document.createElement("a");return e.href=t,e.protocol+"//"+e.host+e.pathname+e.search+e.hash}(t[1]),i.xhrOpen.apply(this,t)},XMLHttpRequest.prototype.send=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=(new Date).getTime();(i.logAjaxFilter&&i.logAjaxFilter(n,o)||!i.logAjaxFilter)&&i.info("[ajax] send: "+o.toLowerCase()+"; request："+n),this.addEventListener("readystatechange",function(){if(i.logAjaxFilter&&i.logAjaxFilter(n,o)||!i.logAjaxFilter)try{if(this.readyState===XMLHttpRequest.DONE){var t=((new Date).getTime()-r)/1e3;200<=this.status&&this.status<400?i.info("request succeed"):i.info("request failed"),i.info("request cost："+t+"; URL："+n+"; request method:"+o),"post"===o.toLowerCase()&&i.info("request data: ",e[0])}}catch(t){i.error("request failed！",t),i.error("URL："+n+";request method："+o+","+this.status),"post"===o.toLowerCase()&&i.error("request data",e[0])}}),i.xhrSend.apply(this,e)}}},b.prototype.saveUnstoreData=function(){var e=this;window.addEventListener("beforeunload",function(t){try{e.logController.flush()}catch(t){console.log(t)}t.preventDefault()})},b.prototype.info=function(t,e){this.logController.log(this.location,o,t,e)},b.prototype.warn=function(t,e){this.logController.log(this.location,n,t,e)},b.prototype.error=function(t,e){this.logController.log(this.location,u,t,e)},b.prototype.get=function(t,e,r){this.logController.get(t,e,r)},b.prototype.keep=function(t){this.logController.keep(t)},b},"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).Mplogd=e()});
