!function(t){"function"==typeof define&&define.amd?define(t):t()}(function(){"use strict";var t,r;t=void 0,r=function(){var e="initing",i="inited",a="failed",c=0,l=1,u=2,d=3,o="info",n="warn",s="error",r=["mplog","report","webcommreport"];function h(t){return(t=t.toString())[1]?t:"0"+t}function p(t){var r="";return/^[0-9]{4}-[0-9]{2}-[0-9]{2}/.test(t)?r+=new Date(t).getTime():/^\d{13}$/.test(t)?r+=t:/^\d{10}$/.test(t)&&(r+=1e3*parseInt(t,10)),parseInt(r,10)}function f(i,a,s,u){return new(s=s||Promise)(function(t,r){function e(t){try{n(u.next(t))}catch(t){r(t)}}function o(t){try{n(u.throw(t))}catch(t){r(t)}}function n(r){r.done?t(r.value):new s(function(t){t(r.value)}).then(e,o)}n((u=u.apply(i,a||[])).next())})}function g(e,o){var n,i,a,t,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return t={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function r(r){return function(t){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(a=2&r[0]?i.return:r[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,r[1])).done)return a;switch(i=0,a&&(r=[2&r[0],a.value]),r[0]){case 0:case 1:a=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!a||r[1]>a[0]&&r[1]<a[3])){s.label=r[1];break}if(6===r[0]&&s.label<a[1]){s.label=a[1],a=r;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(r);break}a[2]&&s.ops.pop(),s.trys.pop();continue}r=o.call(e,s)}catch(t){r=[6,t],i=0}finally{n=a=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,t])}}}function w(o){return void 0===o&&(o=1e8),f(this,void 0,void 0,function(){return g(this,function(t){try{return window.navigator&&window.navigator.storage&&window.navigator.storage.estimate?[2,window.navigator.storage.estimate().then(function(t){var r=t.quota,e=t.usage;return r<=e||o<=e})]:window.navigator&&window.navigator.webkitTemporaryStorage&&window.navigator.webkitTemporaryStorage.queryUsageAndQuota?[2,new Promise(function(e){window.navigator.webkitTemporaryStorage.queryUsageAndQuota(function(t,r){e(r<t||o<=t)})})]:[2,!1]}catch(t){return[2,!1]}return[2]})})}function m(){return f(this,void 0,void 0,function(){return g(this,function(t){try{return window.navigator&&window.navigator.storage&&window.navigator.storage.estimate?[2,window.navigator.storage.estimate().then(function(t){return t.usage})]:window.navigator&&window.navigator.webkitTemporaryStorage&&window.navigator.webkitTemporaryStorage.queryUsageAndQuota?[2,new Promise(function(r){window.navigator.webkitTemporaryStorage.queryUsageAndQuota(function(t){r(t)})})]:[2,0]}catch(t){return[2,0]}return[2]})})}var v="readwrite",y=["enough space","full disk","Maximum key generator","large IndexedDB value"];var b=(t.prototype.insertItems=function(u){return f(this,void 0,void 0,function(){var r,e,o,n,i,a,s=this;return g(this,function(t){switch(t.label){case 0:return[4,m()];case 1:if(2e3<t.sent())return this.throwError(c,"larger than 2000MB"),this.clean(),[2];if(null===(e=this.getTransaction(v)))return this.throwError(d,"transaction is null"),[2,!1];for(o=e.objectStore(this.DB_STORE_NAME),n=0,i=u;n<i.length;n++)a=i[n],(r=o.put(a)).onsuccess=function(){},r.onerror=function(t){return s.checkDB(t),s.throwError(l,"add log failed",t.target.error)};return this.checkCurrentStorage(),[2]}})})},t.prototype.get=function(t,r,e,o){var n=this.getTransaction(v);if(null===n)return this.throwError(d,"transaction is null"),!1;var i=(new Date).getTime(),a=(new Date).getTime();try{i=p(t),a=p(r)}catch(t){this.throwError(l,"invalid time")}var s=n.objectStore(this.DB_STORE_NAME),u=[],c=IDBKeyRange.bound(i,a),h=s.index("timestamp").openCursor(c);return"function"==typeof o?h.onsuccess=function(t){o(t)}:"function"==typeof e&&(h.onsuccess=function(t){var r=t.target.result;r?(u.push({time:r.value.time,level:r.value.level,location:r.value.location,description:r.value.description,data:r.value.data,timestamp:r.value.timestamp}),r.continue()):e(u)}),!0},t.prototype.clean=function(){return f(this,void 0,void 0,function(){var r,i,e,a=this;return g(this,function(t){if(this.cleaning)return[2];if(null===(r=this.getTransaction(v)))return this.throwError(d,"transaction is null"),[2];try{this.throwError(c,"begin clean database"),null===r&&this.throwError(c,"begin clean transaction is none"),(i=r.objectStore(this.DB_STORE_NAME))||this.throwError(c,"begin clean store is none"),(e=i.openCursor()).onsuccess=function(t){a.throwError(c,"begin clean cursor opened");var r=t.target.result;if(!r){a.throwError(c,"begin clean cursor error no result");var e=i.count();e.onsuccess=function(){return f(a,void 0,void 0,function(){return g(this,function(t){switch(t.label){case 0:return this.throwError(c,"begin clean no result"+e.result),[4,m()];case 1:return t.sent()<400&&this.indexedDB.deleteDatabase(this.DB_NAME),[2]}})})}}if(r&&!r.primaryKey&&a.throwError(c,"begin clean cursor error no primarykey",r.key),r&&r.primaryKey){a.cleaning=!0,a.throwError(c,"begin clean get primary key");var o=r.primaryKey,n=i.count();n.onsuccess=function(){a.throwError(c,"begin clean get count");var t=n.result,r=o+Math.ceil(t/5),e=i.delete(IDBKeyRange.bound(o,r,!1,!1));e.onsuccess=function(){a.throwError(c,"clean database success"),a.cleaning=!1},e.onerror=function(t){a.throwError(d,"clean database error",t.target.error)}},n.onerror=function(t){a.throwError(d,"clean database error count error",t.target.error)}}},e.onerror=function(t){a.throwError(d,"clean database error open cursor error",t.target.error)}}catch(t){this.throwError(c,"clean database error",t)}return[2]})})},t.prototype.keep=function(i){var a=this,t=this.getTransaction(v);if(null!==t){var r=t.objectStore(this.DB_STORE_NAME);if(i){var s=t.objectStore(this.DB_STORE_NAME);s.openCursor().onsuccess=function(t){var r=t.target.result;if(r&&r.primaryKey){var n=r.primaryKey,e=Date.now()-60*i*60*24*1e3,o=IDBKeyRange.lowerBound(e);s.indexNames&&s.indexNames.length&&s.indexNames.contains("timestamp")&&(s.index("timestamp").openKeyCursor(o).onsuccess=function(t){if(t.target&&t.target.result){var r=t.target.result.primaryKey,e=s.delete(IDBKeyRange.bound(n,r,!1,!1));e.onsuccess=function(){a.throwError(c,"keep logs success")},e.onerror=function(t){a.throwError(d,"keep logs error",t.target.error)}}else{var o=s.count();o.onsuccess=function(){var t=o.result,r=n+t,e=s.delete(IDBKeyRange.bound(n,r,!1,!1));e.onsuccess=function(){a.throwError(c,"keep logs success")},e.onerror=function(t){a.throwError(d,"keep logs error",t.target.error)}}}})}}}else r.clear().onerror=function(t){return a.throwError(u,"indexedb_keep_clear",t.target.error)}}else this.throwError(d,"transaction is null")},t.prototype.throwError=function(t,r,e){var o=this;this.currentErrorNum+=t,this.currentErrorNum>=this.maxErrorNum&&(this.dbStatus=a,this.poolHandler.pool=[],this.currentErrorNum=0);var n="";e&&(r=r+":"+(e.message||e.stack||e.name),n=e.toString()),console.error&&console.error("Mplog: error msg: "+r+", error detail: "+n);try{if(this.BadJsReport){var i="Mplog: error msg: "+r+", error detail: "+n;this.BadJsReport(r,i)}}catch(t){}!function(r,t){var e=!1;return t.length&&t.forEach(function(t){-1<r.indexOf(t)&&(e=!0)}),e}(n||r,y)?this.dbStatus===a&&!this.timer&&0<t&&(this.timer=setInterval(function(){o.retryDBConnection()},this.retryInterval)):this.clean()},t.prototype.retryDBConnection=function(){this.currentRetryCount+=1,this.currentRetryCount>this.maxRetryCount?(this.dbStatus=a,this.poolHandler.pool=[]):(this.dbStatus=e,this.createDB()),clearInterval(this.timer)},t.prototype.init=function(){return f(this,void 0,void 0,function(){var r;return g(this,function(t){switch(t.label){case 0:return t.trys.push([0,5,,6]),[4,w()];case 1:return t.sent()?(this.throwError(c,"this db size is too large"),[4,m()]):[3,3];case 2:return(r=t.sent())&&0<r&&(100<(r=Math.ceil(r/1e6))&&r<=200?this.throwError(c,"100MB - 200MB"):200<r&&r<=300?this.throwError(c,"200MB - 300MB"):300<r&&r<=400?this.throwError(c,"300MB - 400MB"):400<r&&r<=500?this.throwError(c,"400MB - 500MB"):500<r&&r<=600?this.throwError(c,"500MB - 600MB"):600<r&&r<=1e3?this.throwError(c,"600MB - 1000MB"):this.throwError(c,"larger than 1000MB")),[3,4];case 3:this.throwError(c,"this db size is lower than 100MB"),t.label=4;case 4:return this.createDB(),[3,6];case 5:return t.sent(),console.log("Mplog createDB failed"),[3,6];case 6:return[2]}})})},t.prototype.createDB=function(){return f(this,void 0,void 0,function(){var r,n=this;return g(this,function(t){return this.indexedDB?this.dbStatus!==e?(this.currentRetryCount=this.maxRetryCount+1,this.throwError(d,"indexedDB init error")):(window&&window.navigator&&window.navigator.storage||window&&window.navigator&&window.navigator.webkitTemporaryStorage?this.throwError(c,"user support storage calculation"):this.throwError(c,"user does not support storage calculation"),(r=indexedDB.open(this.DB_NAME,this.DB_VERSION)).onerror=function(t){n.checkDB(t);var r=u;if(t.target.error&&"VersionError"===t.target.error.name){try{var e=t.target.error.message;if(-1<e.search(/The requested version \([0-9]+\) is less than the existing version \([0-9]\)/)){var o=e.match(/[0-9]+/gi)[1];o>n.DB_VERSION&&(n.DB_VERSION=o)}}catch(t){console.log(t)}r=d,n.dbStatus=a}n.throwError(r,"indexedDB open error",t.target.error)},r.onsuccess=function(t){if(n.dbStatus===e){n.timer&&clearInterval(n.timer),n.db=t.target.result,n.dbStatus=i,n.db.onerror=function(t){return n.throwError(u,"indexedDB error",t.target.error)},n.db.onversionchange=function(t){n.db.close(),n.dbStatus=a,n.currentRetryCount=n.maxRetryCount+1,n.throwError(d,"indexedDB version change",t.target.error)};try{n.poolHandler.consume()}catch(t){n.throwError(d,"consume pool error",t)}n.keep7Days&&setTimeout(function(){n.dbStatus!==i?n.poolHandler.push(function(){return n.keep(7)}):n.keep(7)},1e3)}},r.onblocked=function(){n.throwError(u,"indexedDB is blocked")},r.onupgradeneeded=function(t){n.db=t.target.result;try{"function"==typeof n.onupgradeneeded?n.onupgradeneeded(t):n.db.objectStoreNames.contains(n.DB_STORE_NAME)||n.db.createObjectStore(n.DB_STORE_NAME,{autoIncrement:!0}).createIndex("timestamp","timestamp",{unique:!1})}catch(t){n.dbStatus=a,n.throwError(d,"indexedDB upgrade error",t)}}):(this.currentRetryCount=this.maxRetryCount+1,this.throwError(d,"your browser not support IndexedDB.")),[2]})})},t.prototype.checkCurrentStorage=function(){return f(this,void 0,void 0,function(){return g(this,function(t){switch(t.label){case 0:return[4,w(5e7)];case 1:return t.sent()?(this.clean(),[2,!0]):[2,!1]}})})},t.prototype.checkDB=function(t){t&&t.target&&t.target.error&&"QuotaExceededError"===t.target.error.name&&this.clean()},t.prototype.getTransaction=function(t){var r=this,e=null;if(this.dbStatus===a)e=null;else{try{e=this.db.transaction(this.DB_STORE_NAME,t)}catch(t){e=null}e&&(e.onerror=function(t){return t.stopPropagation(),r.throwError(d,"transaction is error")},e.onabort=function(t){t.stopPropagation(),r.checkDB(t)})}return e},t);function t(t,r){this.defaultDbName="mplog",this.defaultDbStoreName="logs",this.dbStatus=e,this.currentErrorNum=0,this.maxRetryCount=3,this.currentRetryCount=0,this.retryInterval=1e4,this.DB_NAME=t&&t.dbName?t.dbName:this.defaultDbName,this.DB_STORE_NAME=t&&t.dbStoreName?t.dbStoreName:this.defaultDbStoreName,this.DB_VERSION=t&&void 0!==t.dbVersion?t.dbVersion:1,this.indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,this.onupgradeneeded=t&&t.onupgradeneeded?t.onupgradeneeded:null,this.maxErrorNum=t&&t.maxErrorNum?t.maxErrorNum:3,this.poolHandler=r,this.keep7Days=!t||!t.keep7Days||t.keep7Days,this.BadJsReport=t&&t.BadJsReport?t.BadJsReport:null,this.init()}var E=(x.prototype.push=function(t){this.pool.length<this.poolSize&&this.pool.push(t)},x.prototype.consume=function(){for(var t=this.pool.shift();t;)t(),t=this.pool.shift()},x);function x(){this.poolSize=20,this.pool=[]}var B=(D.prototype.log=function(t,r,e,o){var n=new Date,i={time:function(t){var r=t.getFullYear(),e=t.getMonth()+1,o=t.getDate(),n=t.getHours(),i=t.getMinutes(),a=t.getSeconds();return[r,e,o].map(h).join("-")+" "+[n,i,a].map(h).join(":")}(n),location:t,level:r,description:e,data:this.dealLength(this.filterFunction(o)),timestamp:n.getTime()};this.bufferLog.push(i),this.bufferLog.length>=this.bufferSize&&(this.flush(this.bufferLog),this.bufferLog=[])},D.prototype.flush=function(t){var r=this;return void 0===t&&(t=this.bufferLog),!(!t||0===t.length)&&(this.reportFunction&&this.reportFunction(t),this.mpIndexedDB.dbStatus!==i?this.poolHandler.push(function(){return r.flush(t)}):(this.mpIndexedDB.insertItems(t),0))},D.prototype.get=function(t,r,e,o){var n=this;if(this.mpIndexedDB.dbStatus!==i)return this.poolHandler.push(function(){return n.get(t,r,e,o)});this.mpIndexedDB.get(t,r,e,o)},D.prototype.keep=function(t){var r=this;if(this.mpIndexedDB.dbStatus!==i)return this.poolHandler.push(function(){return r.keep(t)});this.mpIndexedDB.keep(t)},D.prototype.clean=function(){if(this.mpIndexedDB.dbStatus!==i)return this.poolHandler.push(function(){return this.clean()});this.mpIndexedDB.clean()},D.prototype.dealLength=function(t){return"number"==typeof this.maxLogSize&&"string"==typeof t&&t.length>=this.maxLogSize&&(t=t.substr(0,this.maxLogSize)),t},D.prototype.filterFunction=function(t){try{return"number"==typeof t||"boolean"==typeof t?""+t:"string"==typeof t?t:""}catch(t){console.log(t)}},D);function D(t){this.bufferLog=[],this.bufferSize=t&&void 0!==t.bufferSize?1*t.bufferSize:10,this.maxLogSize=t&&t.maxLogSize?t.maxLogSize:3e3,this.reportFunction=t&&t.reportFunction,this.poolHandler=new E,this.mpIndexedDB=new b(t,this.poolHandler)}function S(t){this.xhrOpen=XMLHttpRequest.prototype.open,this.xhrSend=XMLHttpRequest.prototype.send,this.defaultAjaxFilter=function(t){return-1===r.indexOf(function(t){var r;return t.match(/\/[A-Za-z]+\?/)&&(r=(r=t.match(/\/[A-Za-z]+\?/)[0]).replace("?","").replace("/","")),r}(t))},this.location=t&&t.location?t.location:window.location.href,this.autoLogError=!(!t||void 0===t.autoLogError)&&t.autoLogError,this.autoLogRejection=!(!t||void 0===t.autoLogRejection)&&t.autoLogRejection,this.autoLogAjax=!(!t||void 0===t.autoLogAjax)&&t.autoLogAjax,this.logAjaxFilter=t&&t.logAjaxFilter?t.logAjaxFilter:this.defaultAjaxFilter,this.logController=new B(t),this.bindEvent()}return S.prototype.info=function(t,r){this.logController.log(this.location,o,t,r)},S.prototype.warn=function(t,r){this.logController.log(this.location,n,t,r)},S.prototype.error=function(t,r){this.logController.log(this.location,s,t,r)},S.prototype.get=function(t,r,e,o){this.logController.get(t,r,e,o)},S.prototype.keep=function(t){this.logController.keep(t)},S.prototype.clean=function(){this.logController.clean()},S.prototype.bindEvent=function(){var r=this;this.autoLogError&&window.addEventListener("error",function(t){r.error("[OnError]: "+t.message,"("+t.lineno+'_("行")'+t.colno+'_("列"))')}),this.autoLogRejection&&window.addEventListener("unhandledrejection",function(t){r.error("[OnRejection]:",t.reason)}),this.ajaxHanler(),this.saveUnstoreData()},S.prototype.ajaxHanler=function(){if(this.autoLogAjax){var s,u,c=this;XMLHttpRequest.prototype.open=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];s=t[0],u=function(t){var r=document.createElement("a");return r.href=t,r.protocol+"//"+r.host+r.pathname+r.search+r.hash}(t[1]),c.xhrOpen.apply(this,t)},XMLHttpRequest.prototype.send=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var o=(new Date).getTime(),n=+new Date,i=u,a=s;if(c.logAjaxFilter&&c.logAjaxFilter(u,s)||!c.logAjaxFilter){var r="[ajax] id:"+n+" request "+u+" "+s;"post"===s.toLowerCase()?c.info(r,e[0]):c.info(r)}this.addEventListener("readystatechange",function(){var r="";if(c.logAjaxFilter&&c.logAjaxFilter(i,a)||!c.logAjaxFilter)try{if(this.readyState===XMLHttpRequest.DONE){var t=((new Date).getTime()-o)/1e3;c.info("[ajax] id:"+n+" response "+this.status+" "+i+" "+t,this.responseText)}}catch(t){r="[ajax] id:"+n+" response "+this.status+" "+i,"post"===s.toLowerCase()?c.error(r,e[0]):c.error(r)}}),c.xhrSend.apply(this,e)}}},S.prototype.saveUnstoreData=function(){var t=this;window.addEventListener("beforeunload",function(){try{t.logController.flush()}catch(t){console.log(t)}return null})},S},"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(t=t||self).Mplogd=r()});
